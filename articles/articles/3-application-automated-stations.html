<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>3. Application: Matching nearby stations • cubble</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="3. Application: Matching nearby stations">
<meta property="og:description" content="cubble">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">cubble</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1.0000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/articles/0-create-cubble-from-wild.html">0. Creating a cubble from data in the wild</a>
    </li>
    <li>
      <a href="../../articles/articles/1-details-on-cubble-design.html">1. details-on-cubble-design</a>
    </li>
    <li>
      <a href="../../articles/articles/2-data-manip-with-cubble.html">2. Data manipulation with cubble</a>
    </li>
    <li>
      <a href="../../articles/articles/3-application-automated-stations.html">3. Application: Matching nearby stations</a>
    </li>
    <li>
      <a href="../../articles/articles/4-spatial-temporal-aggregation.html">4. Application: Spatial and temporal aggregation</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="3-application-automated-stations_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>3. Application: Matching nearby stations</h1>
            
      
      
      <div class="hidden name"><code>3-application-automated-stations.Rmd</code></div>

    </div>

    
    
<p>One common type of task with spatio-temporal data is to match nearby sites. For example, we may want to verify the location of an old list of stations with current stations, or we may want to pair the automated weater station with the closest traditional station to calibrate records, or we may want to investigate whether the rainfall will get translated to the river level. Some of these matches only concern the spatial dimension, while others, i.e. matching rainfall and river level, also require the temporal agreement.</p>
<p>This vignette introduces how to spatially and spatio-temporally match between sites with the cubble structure with two examples. The first example pairs traditional weather stations with nearby automated stations in New South Wales, Australia. This exercise only concerns the matching based on spherical distance between stations. The next example pairs the river level recorded by the river gauges with the precipitation recorded by the nearby weather station in Victoria, Australia.</p>
<div id="example-1" class="section level1">
<h1 class="hasAnchor">
<a href="#example-1" class="anchor"></a>Example 1</h1>
<p>In <code>weatherdata::climate_full</code>, New South Wales automated stations are suffixed with <code>aws</code> in its name. This information tells us the automated stations from the traditional one:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nsw_map</span> <span class="op">&lt;-</span> <span class="fu">ozmaps</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ozmaps/man/abs-data.html">abs_ste</a></span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">NAME</span> <span class="op">==</span> <span class="st">"New South Wales"</span><span class="op">)</span>  

<span class="va">nsw</span> <span class="op">&lt;-</span> <span class="fu">weatherdata</span><span class="fu">::</span><span class="va">climate_full</span> <span class="op">%&gt;%</span>   
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">id</span>, <span class="fl">7</span>, <span class="fl">8</span><span class="op">)</span>, <span class="fl">46</span>, <span class="fl">75</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>automated <span class="op">=</span> <span class="fu">str_detect</span><span class="op">(</span><span class="va">name</span>, <span class="st">"aws"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../../reference/stretch.html">stretch</a></span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/month.html">month</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span>,
         <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2020</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../../reference/tamp.html">tamp</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">ts</span><span class="op">$</span><span class="va">tmax</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
 

<span class="fu"><a href="../../reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">nsw_map</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">nsw</span>, 
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">long</span>, y <span class="op">=</span> <span class="va">lat</span>, color <span class="op">=</span> <span class="va">automated</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Dark2"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"New Sourth Wales"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">141</span>, <span class="fl">154</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="3-application-automated-stations_files/figure-html/unnamed-chunk-2-1.png" width="100%"></p>
<p>The color in the map shows whether a station is an automated one or not and some automated stations are actually pretty close to the traditional ones. We would love to know whether records in these nearby pairs align with each other.</p>
<div id="theory" class="section level2">
<h2 class="hasAnchor">
<a href="#theory" class="anchor"></a>Theory</h2>
<p>The two workhorses for matching in a cubble are <code><a href="../../reference/match_sites.html">match_spatial()</a></code> and <code><a href="../../reference/match_sites.html">match_temporal()</a></code>. You can call <code><a href="../../reference/match_sites.html">match_spatial()</a></code> for spatial matching only, or <code><a href="../../reference/match_sites.html">match_sites()</a></code>, which houses both functions, for both spatial and temporal matching. <code><a href="../../reference/match_sites.html">match_sites()</a></code> also has an argument <code>temporal_matching</code>, default to <code>TRUE</code>, for switching on/off the temporal matching, hence <code><a href="../../reference/match_sites.html">match_spatial()</a></code> and <code><a href="../../reference/match_sites.html">match_sites(..., temporal_matching = TRUE)</a></code> are equivalent. By design, all the arguments that control the temporal matching are prefixed with <code>temporal_</code>, so do the arguments for spatial matching.</p>
<p>Here we will given more details on spatial matching and details on the temporal matching is in the <em>Theory</em> section of <em>Example 2</em>. A spatial matching requires two datasets: a <code>major</code> set and a <code>minor</code> set. Spatial matching calculates the spherical distance from <em>each</em> site in the <code>major</code> dataset to <em>every</em> site in the <code>minor</code> dataset using the Vincenty formula.</p>
<p>Once the distance is calculated, three arguments are available to refine the matching results: <code>spatial_single_match</code>, <code>spatial_n_keep</code>, <code>spatial_dist_max</code>. The order that these three arguments applied will slightly affect the results and in <code>cubble</code>, <code>spatial_n_keep</code>, default to 1, is first applied to keep <code>n</code> site(s) for each major site, <code>spaital_dist_max</code>, default to 10, is then applied to filter out the pairs with distance larger than this maximum distance. <code>spatial_single_match</code> is lastly applied to resolve the scenario where site <code>a</code> (minor) is the closest match for both site <code>A</code> and <code>B</code> (major), 5km and 8km respectively, if <code>spatial_single_match = TRUE</code>, <code>a</code> will only be matched to the major site with the smaller distance, that is, site <code>A</code> here.</p>
</div>
<div id="traditional-vs--automated-stations" class="section level2">
<h2 class="hasAnchor">
<a href="#traditional-vs--automated-stations" class="anchor"></a>Traditional vs. Automated stations</h2>
<p>Let’s get back to the New South Wales stations - Here we construct the major site <code>auto</code> and minor <code>non_auto</code> by filtering on whether stations are automated or not. This works in the scenario for examining records from newly-installed automated stations to long-lasting traditional stations (for every newly-installed station, we want to find a nearby traditional one). We apply the spatial matching with <code><a href="../../reference/match_sites.html">match_sites()</a></code> and turn off the temporal matching:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">auto</span> <span class="op">&lt;-</span> <span class="va">nsw</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">automated</span><span class="op">)</span>
<span class="va">non_auto</span> <span class="op">&lt;-</span> <span class="va">nsw</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">automated</span><span class="op">)</span>

<span class="va">matched</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/match_sites.html">match_sites</a></span><span class="op">(</span><span class="va">auto</span>, <span class="va">non_auto</span>, temporal_matching <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> </code></pre></div>
<p>The result from the pairing is also a cubble with two additional columns: <code>.dist</code> as the distance between the pair and <code>.group</code> as the grouping index:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">matched</span> 
<span class="co">#&gt; # Cubble: id-wise: nested form</span>
<span class="co">#&gt; # Key:    id [20]</span>
<span class="co">#&gt;    id            lat  long   elev name      wmo_id automated ts     .dist .group</span>
<span class="co">#&gt;    &lt;chr&gt;       &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;chr&gt;      &lt;dbl&gt; &lt;lgl&gt;     &lt;list&gt; &lt;dbl&gt;  &lt;int&gt;</span>
<span class="co">#&gt;  1 ASN00050137 -33.1  147.  193.  condobol…  95708 TRUE      &lt;tibb…  1.41      1</span>
<span class="co">#&gt;  2 ASN00050052 -33.1  147.  195   condobol…  94707 FALSE     &lt;tibb…  1.41      1</span>
<span class="co">#&gt;  3 ASN00056238 -30.5  152. 1079   armidale…  95773 TRUE      &lt;tibb…  5.16      2</span>
<span class="co">#&gt;  4 ASN00056037 -30.5  152.  987   armidale…  94773 FALSE     &lt;tibb…  5.16      2</span>
<span class="co">#&gt;  5 ASN00064017 -31.3  149.  643   coonabar…  95728 TRUE      &lt;tibb…  6.58      3</span>
<span class="co">#&gt;  6 ASN00064008 -31.3  149.  505   coonabar…  94728 FALSE     &lt;tibb…  6.58      3</span>
<span class="co">#&gt;  7 ASN00048237 -31.5  146.  218   cobar ai…  94710 TRUE      &lt;tibb…  6.86      4</span>
<span class="co">#&gt;  8 ASN00048027 -31.5  146.  260   cobar mo   94711 FALSE     &lt;tibb…  6.86      4</span>
<span class="co">#&gt;  9 ASN00070330 -34.8  150.  640   goulburn…  95716 TRUE      &lt;tibb…  7.03      5</span>
<span class="co">#&gt; 10 ASN00070263 -34.7  150.  670   goulburn…  94716 FALSE     &lt;tibb…  7.03      5</span>
<span class="co">#&gt; 11 ASN00066194 -33.9  151.    3   canterbu…  94766 TRUE      &lt;tibb…  7.14      6</span>
<span class="co">#&gt; 12 ASN00066037 -33.9  151.    6   sydney a…  94767 FALSE     &lt;tibb…  7.14      6</span>
<span class="co">#&gt; 13 ASN00068192 -34.0  151.   73.9 camden a…  94755 TRUE      &lt;tibb…  8.17      7</span>
<span class="co">#&gt; 14 ASN00068257 -34.1  151.  112   campbell…  94757 FALSE     &lt;tibb…  8.17      7</span>
<span class="co">#&gt; 15 ASN00072160 -36.1  147.  164.  albury a…  95896 TRUE      &lt;tibb…  8.33      8</span>
<span class="co">#&gt; 16 ASN00072023 -36.1  147.  184   hume res…  94901 FALSE     &lt;tibb…  8.33      8</span>
<span class="co">#&gt; 17 ASN00067113 -33.7  151.   24.7 penrith …  94763 TRUE      &lt;tibb…  8.77      9</span>
<span class="co">#&gt; 18 ASN00063077 -33.7  151.  320   springwo…  95744 FALSE     &lt;tibb…  8.77      9</span>
<span class="co">#&gt; 19 ASN00063291 -33.4  150.  744.  bathurst…  94729 TRUE      &lt;tibb…  9.30     10</span>
<span class="co">#&gt; 20 ASN00063005 -33.4  150.  713   bathurst…  94730 FALSE     &lt;tibb…  9.30     10</span></code></pre></div>
<p>Then we can create visualisation to see where these pairs are in the map:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../../reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">nsw_map</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">matched</span>, 
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">long</span>, y <span class="op">=</span> <span class="va">lat</span>, color <span class="op">=</span> <span class="va">automated</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggrepel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html">geom_label_repel</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">matched</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">automated</span><span class="op">)</span>,
                            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">long</span>, y <span class="op">=</span> <span class="va">lat</span>, label <span class="op">=</span> <span class="va">.group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Dark2"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"New South Wales"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">141</span>, <span class="fl">154</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="3-application-automated-stations_files/figure-html/unnamed-chunk-5-1.png" width="100%"></p>
<p>or compare the series within the same pair (as an example here we only look at records in Jan 2020):</p>
<p><img src="3-application-automated-stations_files/figure-html/unnamed-chunk-6-1.png" width="100%"></p>
<p>We can see that in general the maximum temperatures recorded in traditional and automated stations from our pairs are matched. There’s a constant gap in pair 9, which suggests the two stations need to be further calibrated.</p>
</div>
</div>
<div id="example-2" class="section level1">
<h1 class="hasAnchor">
<a href="#example-2" class="anchor"></a>Example 2</h1>
<p>The water level data comes from <a href="http://www.bom.gov.au/metadata/catalogue/19115/ANZCW0503900528?template=full">Bureau of Meteorology</a> and has a copy in <code>weatherdata</code>. Here we extract the water course level and add a column annotate this data of type <code>river</code>. For the rainfall data, we will still use the <code>weatherdata::climate_full</code>, filtering for Victorian stations in 2020 should be pretty familiar by now. Again, we first look at where these stations are on the map first:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">river</span> <span class="op">&lt;-</span> <span class="fu">weatherdata</span><span class="fu">::</span><span class="va">water</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../../reference/stretch.html">stretch</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">date</span>, <span class="va">Water_course_level</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../../reference/tamp.html">tamp</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"river"</span><span class="op">)</span>

<span class="va">climate</span> <span class="op">&lt;-</span> <span class="fu">weatherdata</span><span class="fu">::</span><span class="va">climate_full</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/between.html">between</a></span><span class="op">(</span><span class="fu">stringr</span><span class="fu">::</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">id</span>, <span class="fl">7</span>, <span class="fl">8</span><span class="op">)</span>, <span class="fl">76</span>, <span class="fl">90</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../../reference/stretch.html">stretch</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2020</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../../reference/tamp.html">tamp</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"climate"</span><span class="op">)</span>

<span class="va">vic_map</span> <span class="op">&lt;-</span> <span class="fu">rmapshaper</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rmapshaper/man/ms_simplify.html">ms_simplify</a></span><span class="op">(</span><span class="fu">ozmaps</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ozmaps/man/abs-data.html">abs_ste</a></span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">NAME</span> <span class="op">==</span> <span class="st">"Victoria"</span><span class="op">)</span><span class="op">)</span>  
<span class="fu"><a href="../../reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">vic_map</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">river</span>, <span class="va">climate</span><span class="op">)</span> , 
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">long</span>, y <span class="op">=</span> <span class="va">lat</span>, color <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Dark2"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="3-application-automated-stations_files/figure-html/unnamed-chunk-7-1.png" width="100%"></p>
<div id="theory-1" class="section level2">
<h2 class="hasAnchor">
<a href="#theory-1" class="anchor"></a>Theory</h2>
<p>Temporal matching checks how spatially matched pairs align temporally. We use the following chart to illustrate how the temporal matching works:</p>
<p><img src="3-application-automated-stations_files/figure-html/unnamed-chunk-8-1.png" width="100%"></p>
<p>For each spatially matched pair, say <code>A</code> and <code>a</code>, we first find the largest <code>n</code> points in each series, colored in brown points here. Here we use the largest three but you can tune this number by <code>temporal_n_highest</code>. Then we construct the interval of the largest points from one series and see how many points, from the other series, fall into the intervals. The series used to construct the interval is controlled by <code>temporal_independent</code> and the window size by <code>temporal_window</code> with a default of 5.</p>
<p>In this illustration, we construct the interval based on series <code>A</code> and two of the three peaks from <code>a</code> falls into this interval at Time 7 and 27.</p>
</div>
<div id="rainfall-translates-into-river-level" class="section level2">
<h2 class="hasAnchor">
<a href="#rainfall-translates-into-river-level" class="anchor"></a>Rainfall translates into river level</h2>
<p>There’s another mandatory argument that hasn’t been introduced above: <code>temporal_var_to_match</code>. This argument controls the variable to match and it needs to appear in both the <code>major</code> and <code>minor</code> set. In the water level matching example, we match the variable <code>Water_course_level</code> from <code>river</code> to <code>prcp</code> from <code>climate</code>, hence need to manually rename one of them to match the other, here we rename <code>Water_course_level</code> to <code>prcp</code> in <code>river</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">river</span> <span class="op">&lt;-</span> <span class="va">river</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../../reference/stretch.html">stretch</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>prcp <span class="op">=</span> <span class="va">Water_course_level</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../../reference/tamp.html">tamp</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Now we use <code><a href="../../reference/match_sites.html">match_sites()</a></code> to first pair the weather stations with the river gauges spatially and then apply the temporal matching on <code>prcp</code>. We will construct the interval based on peaks in <code>climate</code> since we would expect a lag effect for precipitation to flow into the river and cause a raise in river level, hence <code>temporal_independent = climate</code>. We select the 30 highest peak from the series to construct the match by setting <code>temporal_n_highest = 30</code>. This is a tuning parameter and you can start with 10% of the points of one series (here we have daily data for a year, 10% is roughly 30 points). <code>temporal_min_match</code> filters out pairs don’t have enough match and to return all the pairs, set <code>temporal_min_match</code> to <code>0</code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/match_sites.html">match_sites</a></span><span class="op">(</span><span class="va">river</span>, <span class="va">climate</span>,
                   temporal_var_to_match <span class="op">=</span> <span class="va">prcp</span>,
                   temporal_independent <span class="op">=</span> <span class="va">climate</span>,
                   temporal_n_highest <span class="op">=</span> <span class="fl">30</span>,
                   temporal_min_match <span class="op">=</span> <span class="fl">15</span>
<span class="op">)</span>

<span class="va">res</span>
<span class="co">#&gt; # Cubble: id-wise: nested form</span>
<span class="co">#&gt; # Key:    id [8]</span>
<span class="co">#&gt;   id          name                lat  long type  ts        .dist .group n_match</span>
<span class="co">#&gt;   &lt;chr&gt;       &lt;chr&gt;             &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; &lt;list&gt;    &lt;dbl&gt;  &lt;int&gt;   &lt;int&gt;</span>
<span class="co">#&gt; 1 405234      SEVEN CREEKS @ D… -36.9  146. river &lt;tibble …  6.15      5      21</span>
<span class="co">#&gt; 2 ASN00082042 strathbogie       -36.8  146. clim… &lt;tibble …  6.15      5      21</span>
<span class="co">#&gt; 3 404207      HOLLAND CREEK @ … -36.6  146. river &lt;tibble …  8.54     10      21</span>
<span class="co">#&gt; 4 ASN00082170 benalla airport   -36.6  146. clim… &lt;tibble …  8.54     10      21</span>
<span class="co">#&gt; 5 230200      MARIBYRNONG RIVE… -37.7  145. river &lt;tibble …  6.17      6      19</span>
<span class="co">#&gt; 6 ASN00086038 essendon airport  -37.7  145. clim… &lt;tibble …  6.17      6      19</span>
<span class="co">#&gt; 7 406213      CAMPASPE RIVER @… -37.0  145. river &lt;tibble …  1.84      1      18</span>
<span class="co">#&gt; 8 ASN00088051 redesdale         -37.0  145. clim… &lt;tibble …  1.84      1      18</span></code></pre></div>
<p>The output from temporal matching is also a cubble, with additional column <code>.dist</code> and <code>.group</code> inherent from spatial matching and <code>n_match</code> for the number of matched temporal peaks. Then you can use this output to plot the location of match:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../../reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">vic_map</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">res</span>, 
             <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">long</span>, y <span class="op">=</span> <span class="va">lat</span>, color <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">ggrepel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html">geom_label_repel</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">res</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">type</span> <span class="op">==</span> <span class="st">"river"</span><span class="op">)</span>,
                            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">long</span>, y <span class="op">=</span> <span class="va">lat</span>, label <span class="op">=</span> <span class="va">.group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Dark2"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Victoria"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>,
        panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="3-application-automated-stations_files/figure-html/unnamed-chunk-11-1.png" width="100%"></p>
<p>Or to look at the series:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">res_long</span> <span class="op">&lt;-</span> <span class="va">res</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../../reference/stretch.html">stretch</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../../reference/migrate.html">migrate</a></span><span class="op">(</span><span class="va">.group</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prcp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html">scale</a></span><span class="op">(</span><span class="va">prcp</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../../reference/switch_key.html">switch_key</a></span><span class="op">(</span><span class="va">.group</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">.group</span>, <span class="va">type</span>, <span class="va">id</span><span class="op">)</span><span class="op">)</span>

<span class="va">res_long</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">prcp</span>, color <span class="op">=</span> <span class="va">type</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html">vars</a></span><span class="op">(</span><span class="va">.group</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span><span class="op">(</span>palette <span class="op">=</span> <span class="st">"Dark2"</span>, guide <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span>  <span class="st">"week"</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_date.html">scale_x_date</a></span><span class="op">(</span>date_labels <span class="op">=</span> <span class="st">"%b"</span><span class="op">)</span></code></pre></div>
<p><img src="3-application-automated-stations_files/figure-html/unnamed-chunk-12-1.png" width="100%"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by H. Sherry Zhang, Dianne Cook, Ursula Laa, Nicolas Langrené, Patricia Menéndez.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
