<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>0. Creating a cubble from data in the wild • cubble</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="0. Creating a cubble from data in the wild">
<meta property="og:description" content="cubble">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">cubble</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1.0000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/articles/aws.html">Comparing records in Automated and traditional weather stations</a>
    </li>
    <li>
      <a href="../../articles/articles/upstream.html">0. Creating a cubble from data in the wild</a>
    </li>
    <li>
      <a href="../../articles/articles/workflow.html">2. Data manipulation with cubble</a>
    </li>
    <li>
      <a href="../../articles/attributes.html">1. Cubble attributes</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="upstream_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>0. Creating a cubble from data in the wild</h1>
            
      
      
      <div class="hidden name"><code>upstream.Rmd</code></div>

    </div>

    
    
<p>This article shows you how to create a cubble from data in the wild through the example of query climate data from National Oceanic and Atmospheric Administration (NOAA) using the <code>rnoaa</code> package.</p>
<p>While there are many ways to query the data from NOAA, here I introduce a workflow using row-wise data frame, which makes it easy to turn into a cubble. This involves first create a row-wise tibble with one row per station, and then query the climate data as a nested list for each station.</p>
<p>Suppose we want to find a few climate stations close to Melbourne and Sydney, <code>rnoaa</code> has a function <code>meteo_nearby_stations()</code> for this task, given the coordinates of the locations. Here we create <code>lat_long_df</code> that contains the coordinates of the two cities. We also create a station data, <code>all_stations</code>, that includes all the Australia stations with a WMO ID and have records in 2020. This reduce the searching range from stations all over the global to only Australian stations and records from WMO stations tend to have better quality control. We set <code>limit = 5</code> to query 5 closest stations of each city. After some cleaning, this is what we’ve got:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">lat_lon_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sydney"</span>, <span class="st">"melbourne"</span><span class="op">)</span>,
                         latitude <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">33.8675</span>, <span class="op">-</span><span class="fl">37.8136</span><span class="op">)</span>,
                         longitude <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">151.2070</span>, <span class="fl">144.9631</span><span class="op">)</span><span class="op">)</span>

<span class="va">all_stations</span> <span class="op">&lt;-</span> <span class="fu">ghcnd_stations</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">id</span>, <span class="st">"ASN"</span><span class="op">)</span>,
         <span class="va">first_year</span> <span class="op">&lt;</span> <span class="fl">2020</span>,
         <span class="va">last_year</span> <span class="op">&gt;</span> <span class="fl">2019</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>wmo_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">wmo_id</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">wmo_id</span><span class="op">)</span><span class="op">)</span>

<span class="va">nearby_stations</span> <span class="op">&lt;-</span>  <span class="fu">meteo_nearby_stations</span><span class="op">(</span>lat_lon_df <span class="op">=</span> <span class="va">lat_lon_df</span>,
                                          station_data <span class="op">=</span> <span class="va">all_stations</span>, 
                                          limit <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>

<span class="va">stations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">nearby_stations</span><span class="op">$</span><span class="va">melbourne</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>city <span class="op">=</span> <span class="st">"melbourne"</span><span class="op">)</span>,
                      <span class="va">nearby_stations</span><span class="op">$</span><span class="va">sydney</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>city <span class="op">=</span> <span class="st">"sydney"</span><span class="op">)</span><span class="op">)</span>

<span class="va">stations</span></code></pre></div>
<p>With these 10 stations, we want to make sure they all have precipitation (<code>PRCP</code>), maximum temperature (<code>TMAX</code>), and minimum temperature (<code>TMIN</code>) recorded. <code>ncdc_datatypes()</code> allows us to query the variables recorded for each station. We use <code><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise()</a></code> to formulate the tibble as a row-wise data frame and append a list column, <code>var</code>, that shows the variables recorded for each station. The three variables <code>PRCP</code>, <code>TMAX</code>, and <code>TMIN</code> are then detected to filter for the stations:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">station_selected</span> <span class="op">&lt;-</span> <span class="va">stations</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">ncdc_datatypes</span><span class="op">(</span>datasetid <span class="op">=</span> <span class="st">"GHCND"</span>, 
                                   stationid <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"GHCND:"</span>, <span class="va">id</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prcp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">var</span><span class="op">$</span><span class="va">id</span>, <span class="st">"PRCP"</span><span class="op">)</span><span class="op">)</span>,
         tmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">var</span><span class="op">$</span><span class="va">id</span>, <span class="st">"TMAX"</span><span class="op">)</span><span class="op">)</span>,
         tmin <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu">str_detect</span><span class="op">(</span><span class="va">var</span><span class="op">$</span><span class="va">id</span>, <span class="st">"TMIN"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">prcp</span>, <span class="va">tmax</span>, <span class="va">tmin</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">var</span><span class="op">:</span><span class="va">tmin</span><span class="op">)</span><span class="op">)</span>

<span class="va">station_selected</span></code></pre></div>
<p>After the filter, we can see that one of the Sydney stations, <code>SYDNEY HARBOUR</code>, is removed. A further investigation shows that it doesn’t record precipitation.</p>
<p>Lastly, we can grab the climate data with <code>meteo_pull_monitors()</code> and again, with the row-wise data frame structure, we can append all the climate information into a list-column without expanding the time dimension. To make it quick-and-dirty, we only query the results in January 2020.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sydmel_climate</span> <span class="op">&lt;-</span> <span class="va">station_selected</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu">meteo_pull_monitors</span><span class="op">(</span><span class="va">id</span>, 
                                       date_min <span class="op">=</span> <span class="st">"2020-01-01"</span>, 
                                       date_max <span class="op">=</span> <span class="st">"2020-01-31"</span>,
                                       var <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"PRCP"</span>, <span class="st">"TMAX"</span>, <span class="st">"TMIN"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">sydmel_climate</span></code></pre></div>
<p>If you have followed along, the output you have should be a row-wise data frame with all the climate time series data nested into a column called <code>ts</code>. This data can be directly turned into a cubble with <code>tamp</code> with a supply of the grouping variable, <code>id</code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sydmel_climate</span> <span class="op">%&gt;%</span> <span class="fu"><a href="../../reference/tamp.html">tamp</a></span><span class="op">(</span><span class="va">id</span><span class="op">)</span></code></pre></div>
<p>Here you go! Let’s look at these stations on the map:</p>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by H. Sherry Zhang, Dianne Cook, Ursula Laa, Nicolas Langrené, Patricia Menéndez.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
