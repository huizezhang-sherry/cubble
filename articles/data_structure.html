<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>data_structure • cubble</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="data_structure">
<meta property="og:description" content="cubble">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cubble</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1.0000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/data_structure.html">data_structure</a>
    </li>
    <li>
      <a href="../articles/workflow.html">workflow</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="data_structure_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>data_structure</h1>
            
      
      
      <div class="hidden name"><code>data_structure.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">cubble</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tsibble.tidyverts.org">tsibble</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org">stringr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">ozmaps</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">sf</span><span class="op">)</span></code></pre></div>
<div id="motivation-for-a-new-data-structure" class="section level1">
<h1 class="hasAnchor">
<a href="#motivation-for-a-new-data-structure" class="anchor"></a>Motivation for a new data structure:</h1>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">climate</span> <span class="op">&lt;-</span> <span class="va">climate_monthly</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>

<span class="co"># build a tsibble</span>
<span class="va">climate_tsibble</span> <span class="op">&lt;-</span> <span class="va">climate</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>date <span class="op">=</span> <span class="fu"><a href="https://tsibble.tidyverts.org/reference/year-month.html">yearmonth</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tsibble.tidyverts.org/reference/as-tsibble.html">as_tsibble</a></span><span class="op">(</span>key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">station</span>, <span class="va">param</span><span class="op">)</span>, index <span class="op">=</span> <span class="va">date</span><span class="op">)</span>

<span class="co"># build an sf from tsibble - so far so good</span>
<span class="va">climate_sf</span> <span class="op">&lt;-</span> <span class="va">climate_tsibble</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">lat</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">st_as_sf</span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"long"</span>, <span class="st">"lat"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="va">ozmap_country</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">climate_sf</span><span class="op">)</span>

<span class="co"># spatial join returns an tibble/ sf - lose the tsibble structure</span>
<span class="va">a</span> <span class="op">&lt;-</span> <span class="va">climate_sf</span> <span class="op">%&gt;%</span> 
  <span class="fu">st_join</span><span class="op">(</span><span class="va">ozmap_states</span>, join <span class="op">=</span> <span class="va">st_within</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span> 

<span class="co"># turning it to tsibble again loses the sf structure</span>
<span class="va">b</span> <span class="op">&lt;-</span> <span class="va">a</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://tsibble.tidyverts.org/reference/as-tsibble.html">as_tsibble</a></span><span class="op">(</span>index <span class="op">=</span> <span class="va">date</span>, key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">station</span>, <span class="va">param</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span>
<span class="va">b</span> <span class="op">%&gt;%</span> <span class="fu">st_join</span><span class="op">(</span><span class="va">ozmap_states</span>, join <span class="op">=</span> <span class="va">st_within</span><span class="op">)</span>

<span class="co"># hence would be nice to have a data structure that deal with both dimensions</span>
<span class="co"># Building such a data structure would mean dependence on both tsibble and sf </span></code></pre></div>
</div>
<div id="existing-and-similar-work" class="section level1">
<h1 class="hasAnchor">
<a href="#existing-and-similar-work" class="anchor"></a>Existing and similar work:</h1>
<div id="data-structure" class="section level2">
<h2 class="hasAnchor">
<a href="#data-structure" class="anchor"></a>Data structure:</h2>
<ul>
<li>
<p><code>spacetime</code> builds a spatiotemporal object based on <code>xts</code> and <code>sp</code> class for handling time and spatial dimension. Both classes have been superseded by modern data structure, namely, <code>tsibble</code> and <code>sf</code>, respectively.</p>
<ul>
<li>Spacetime: Spatio-Temporal Data in R</li>
</ul>
</li>
<li>
<p><code>stars</code> package defines the spatiotemporal data as an array and provides operations based on the array structure. This definition fits well with the satellite imagery from remote sensing, where pixels in the image corresponds to the cells in the array.</p>
<ul>
<li><p><a href="https://github.com/r-spatial/stars/" class="uri">https://github.com/r-spatial/stars/</a></p></li>
<li><p>“Multidimensional Arrays for anlaysing geoscientific data”</p></li>
<li><p>“Spatio-temporal change detection from multidimensional arrays: Detecting deforestation from MOBIS time series”</p></li>
</ul>
</li>
<li>
<p><code>cubelyr</code> implements a <code>tbl_cube</code> class for tidyverse operations on arrays.</p>
<ul>
<li><a href="https://github.com/hadley/cubelyr/blob/master/R/cube.R" class="uri">https://github.com/hadley/cubelyr/blob/master/R/cube.R</a></li>
</ul>
</li>
<li>
<p><code>sf</code> implements a flat data structure for handling different geometry types in spatial data and introduces a set of operations based on the geometrical relations.</p>
<ul>
<li>Simple Features for R: standardized support for spatial vector data</li>
</ul>
</li>
<li>
<p><code>tsibble</code> implements a data structure for temporal data through defining the <code>key</code> and <code>index</code> variable</p>
<ul>
<li>A new tidy data structure to support exploration and modeling of temporal data</li>
</ul>
</li>
</ul>
</div>
<div id="data-wrangling-operations" class="section level2">
<h2 class="hasAnchor">
<a href="#data-wrangling-operations" class="anchor"></a>Data wrangling operations:</h2>
<ul>
<li>
<p>There are also array operations defined in the following paper: <strong>select, scale, reduce, rearrange, and compute</strong>.</p>
<ul>
<li>Spatio-temporal change detection from multidimensional arrays: Detecting deforestation from MOBIS time series"</li>
</ul>
</li>
<li>
<p>The package is still in experimental and the operations supported includes <strong>select, rename filter, mutate, arrange, group_by/ungroup, and summarise (no join).</strong></p>
<ul>
<li><code>cubelyr</code></li>
</ul>
</li>
</ul>
</div>
<div id="how-my-work-differs" class="section level2">
<h2 class="hasAnchor">
<a href="#how-my-work-differs" class="anchor"></a>How my work differs:</h2>
<ul>
<li>
<p>fixed set of locations + interest in time domain</p>
<ul>
<li><p>While satellite imagery can record information on a continuous spatial domain, other spatial information are recorded at a fixed set of locations characterised by latitude, longitude, and other spatial metadata. Examples of this type of data includes climate measures from weather observation stations and river level data recorded by electronic gauges. Analysing this data requires less considerations on the geometry type and map projection while more on how measures in these fixed locations changes across the time domain and whether these changes are related for adjacent locations.</p></li>
<li>
<p>characteristics:</p>
<ul>
<li><p>less focus on complex geometry structure (point geometry) and projection</p></li>
<li><p>more focus on the time dimension</p></li>
<li><p>can be regular or irregular grid</p></li>
</ul>
</li>
</ul>
</li>
<li><p>A flat data structure for saptiotemporal data built on top of <code>tibble</code> means the adoption of tidyverse workflow where the data type and inputs and outputs are predictable and hence operations can be concatenated on top of one another. This workflow enhances the reproducibility of data analysis.</p></li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">water_large</span>
<span class="va">spatio</span> <span class="op">&lt;-</span> <span class="va">water_large</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">station</span>, <span class="va">name</span>, <span class="va">lat</span>, <span class="va">long</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/distinct.html">distinct</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">dist</span> <span class="op">&lt;-</span> <span class="fu">expand_grid</span><span class="op">(</span>from <span class="op">=</span> <span class="va">spatio</span><span class="op">$</span><span class="va">station</span>, to <span class="op">=</span> <span class="va">spatio</span><span class="op">$</span><span class="va">station</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">spatio</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"from"</span> <span class="op">=</span> <span class="st">"station"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">spatio</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"to"</span> <span class="op">=</span> <span class="st">"station"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>dist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="op">(</span><span class="va">lat.x</span> <span class="op">-</span> <span class="va">lat.y</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="op">(</span><span class="va">long.x</span> <span class="op">-</span> <span class="va">long.y</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dist</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">nest</span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">from</span>, <span class="va">name.x</span>, <span class="va">lat.x</span>, <span class="va">long.x</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu">map</span><span class="op">(</span><span class="va">data</span>, <span class="op">~</span><span class="va">.x</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">to</span>, <span class="va">dist</span>, <span class="va">name.y</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">dist</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> 


<span class="co"># cross tabulate the key to create a separate spatio sheet </span>
<span class="va">water_large</span> <span class="op">%&gt;%</span> 
  <span class="co"># nested calculation of distance on the spatio sheet</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span><span class="op">(</span>dist <span class="op">=</span> <span class="fu">closest</span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>, on_spatio <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>  
  <span class="co"># dist is on the spatio sheet but can be called by the main sheet </span>
  <span class="co"># find the distance &lt; 1 for station 221224</span>
  <span class="co"># look at spatial sheet for filtering if key is involved???? </span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">dist</span> <span class="op">&lt;</span> <span class="fl">1</span>, <span class="va">station</span> <span class="op">==</span> <span class="st">"221224"</span><span class="op">)</span>
  </code></pre></div>
</div>
</div>
<div id="a-relational-data-structure" class="section level1">
<h1 class="hasAnchor">
<a href="#a-relational-data-structure" class="anchor"></a>A relational data structure</h1>
<p>In spatiotemporal data, A single table data structure repeats the recording of time-invariant measures. This significantly increases the computation time and storage needed for those data that are long in the time dimension. Cubble implements a relational data structure with two tables that separately record time-variant and invariant variables for spatiotemporal data. After creating a cubble object, the two main verbs <code>choose</code> and <code>cubble_join</code> choose the table to work on and join the output results to either the main or item sheet depending on whether the results are time-variant or invariant. All the intermediate syntaxes can be written as usual without being affected.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">cubble</span><span class="op">(</span><span class="va">climate</span>, <span class="va">station</span>, key <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"station"</span> <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span><span class="op">)</span>

<span class="va">df</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/Special.html">choose</a></span><span class="op">(</span><span class="va">climate</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="va">...</span> <span class="op">%&gt;%</span> 
  <span class="fu">cubble_join</span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
<div id="nesting" class="section level1">
<h1 class="hasAnchor">
<a href="#nesting" class="anchor"></a>Nesting</h1>
<p><code>nest_by</code> is a verb I recently discovered in dplyr. It is powered by the <code>rowwise</code> operation to create a list-column that nests each group into one row. I think it is a nice structure that makes compute station-wise values much easier (see below). However, I think the unnest workflow can be improved a bit further: currently, one need to use both <code>unnest</code> + <code>ungroup</code> to restore to the initial unnested and ungrouped stage. It would be nice to have these two operations combined.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">start_end</span> <span class="op">&lt;-</span> <span class="va">climate</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">station</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>, 
         end <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">date</span><span class="op">)</span><span class="op">)</span>

<span class="va">count_var</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dt</span><span class="op">)</span><span class="op">{</span>
  <span class="va">dt</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="va">prcp</span><span class="op">:</span><span class="va">tavg</span>, names_to <span class="op">=</span> <span class="st">"datatype"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">datatype</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="co"># think of a better way to filter out those block missing</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>missing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">missing</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">climate</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by</a></span><span class="op">(</span><span class="va">station</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>var_count <span class="op">=</span> <span class="fu">count_var</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">start_end</span> <span class="op">%&gt;%</span> 
  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>The associated <code><a href="https://dplyr.tidyverse.org/reference/nest_by.html">nest_by()</a></code> can join two data frames while keep a nesting structure. With <code>rowwise</code>, this is elegant to compute station-wise information. Currently, it doesn’t support the nested list to be a tsibble tho.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">joined</span> <span class="op">&lt;-</span> <span class="va">station</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_join.html">nest_join</a></span><span class="op">(</span><span class="va">climate</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"id"</span> <span class="op">=</span> <span class="st">"station"</span><span class="op">)</span><span class="op">)</span>

<span class="va">joined</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">climate</span><span class="op">$</span><span class="va">date</span><span class="op">)</span><span class="op">)</span>

<span class="va">joined2</span> <span class="op">&lt;-</span> <span class="va">climate</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/nest_join.html">nest_join</a></span><span class="op">(</span><span class="va">station</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"station"</span> <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Also, referening to variables in the list-column is not particularly convenient with the current infrastructure. For example, in an example to add the proportion of presence for <code>prcp</code> column, it would be nice if we can drop <code>data$</code> when referencing to variable in the nested list.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">start_end</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>prcp_missing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">prcp</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">prcp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Also to repeat this calculation for all the variables (<code>prcp</code>: <code>tavg</code>) in an unnested structure, we can do</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">climate</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">prcp</span><span class="op">:</span> <span class="va">tavg</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>But this won’t work in list-column</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">start_end</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">prcp</span><span class="op">:</span> <span class="va">data</span><span class="op">$</span><span class="va">tavg</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co"># Error: Problem with `mutate()` input `..1`.</span>
<span class="co"># ℹ `..1 = across(data$prcp:data$tavg, ~sum(is.na(.x))/length(.x))`.</span>
<span class="co"># x object of type 'closure' is not subsettable</span>
<span class="co"># ℹ The error occurred in row 1.</span>
<span class="co"># Run `rlang::last_error()` to see where the error occurred.</span></code></pre></div>
</div>
<div id="long-or-wide-form" class="section level1">
<h1 class="hasAnchor">
<a href="#long-or-wide-form" class="anchor"></a>Long or wide form?</h1>
<p>Now I prefer a wide form rather than long form for the main dataset. Long form is easier to operate upon when all the variables require the same operation (i.e. aggregate all the variables by mean) while wide form is more friendly for operations on individual variables. There has been <code><a href="https://dplyr.tidyverse.org/reference/across.html">across()</a></code> implemented to batch process variables with the same operation, which I think is rather elegant. Using long form would imply re-define column-wise dplyr verbs in the context of long form (i.e. select/ deselect a variable is somehow a filter, mutate becomes somehow adding rows).</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Sherry Zhang.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
