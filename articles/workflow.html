<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>workflow • cubble</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="workflow">
<meta property="og:description" content="cubble">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cubble</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.1.0000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/workflow.html">workflow</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="workflow_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>workflow</h1>
            
      
      
      <div class="hidden name"><code>workflow.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">cubble</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tsibble.tidyverts.org">tsibble</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></code></pre></div>
<div id="create-a-cubble" class="section level1">
<h1 class="hasAnchor">
<a href="#create-a-cubble" class="anchor"></a>Create a cubble</h1>
<p>A cubble object uses a nested form and a long form, powered by the <code>rowwise_df</code> and <code>grouped_df</code>, to allow flexible group-wise and time-wise computation for spatial-temporal data.</p>
<p>To create a cubble object in the nested form, use <code><a href="../reference/tamp.html">tamp()</a></code> with a supply of the grouping variable. This would add <code>cubble_df</code> and <code>rowwise_df</code> to the underlying data structure the object is built upon. On top of the attributes inherent from tibble (<code>name</code> and <code>row.names</code>) and rowwise_df (<code>groups</code>), a cubble has two additional attributes: <code>meta</code> and <code>form</code>. <code>meta</code> stores the group-wise information so that the object can be switched between the list-column and long form without the lost of information while <code>form</code> specifies whether the data object is a list-column or long form.</p>
<p>In the nested form, each distinct key value constitutes a row and all the time-specific measures are nested into a column named <code>ts</code>. This form is convenient for calculating group-wise measures.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">oz_global</span> <span class="op">&lt;-</span> <span class="va">climate_flat</span>  <span class="op">%&gt;%</span> <span class="fu">global</span><span class="op">(</span><span class="va">station</span><span class="op">)</span>
<span class="va">oz_global</span></code></pre></div>
<p><code>zoom()</code> switches a cubble object into the long form where all the group-specific variables are suppressed into the <code>meta</code> attributes. This form is time-centric and is useful to compute time-wise variables.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">oz_zoom</span> <span class="op">&lt;-</span> <span class="va">oz_global</span> <span class="op">%&gt;%</span> <span class="fu">zoom</span><span class="op">(</span><span class="op">)</span>
<span class="va">oz_zoom</span></code></pre></div>
<p>The long form and the nested form can be switched between each other by using <code>global()</code> on a long form cubble and <code>zoom()</code> on a list-column cubble. Since a cubble has a grouping variable as an attribute, there’s no need to specify the grouping variable again.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">back</span> <span class="op">&lt;-</span> <span class="va">oz_zoom</span> <span class="op">%&gt;%</span> <span class="fu">global</span><span class="op">(</span><span class="op">)</span>
<span class="va">back</span></code></pre></div>
</div>
<div id="manipulation" class="section level1">
<h1 class="hasAnchor">
<a href="#manipulation" class="anchor"></a>Manipulation</h1>
<div id="work-with-dplyr-verbs" class="section level2">
<h2 class="hasAnchor">
<a href="#work-with-dplyr-verbs" class="anchor"></a>Work with dplyr verbs</h2>
<p>Below are three examples on how to manipulate a cubble object with dplyr verbs:</p>
<div id="example-1" class="section level3">
<h3 class="hasAnchor">
<a href="#example-1" class="anchor"></a>Example 1</h3>
<p>In the first example, we want to only keep the stations that have <code>tmax</code> recorded in 2020. This requires first narrow down the records to those in 2020, determine if <code>tmax</code> is missing for each station, and then retain those stations that have <code>tmax</code> recorded. The year filtering is an operation on the time axis, so we start with the long form. Whether each station has <code>tmax</code> recorded is a result of each station, rather than of each time point, hence we need to switch to the nested form with <code>global()</code>. To calculate whether <code>tmax</code> is recorded, we mutate a column <code>tmax_missing</code> that takes <code>TRUE</code> if all the <code>tmax</code> in the nested list column <code>ts</code> are <code>NA</code> and <code>FALSE</code> otherwise. To get the stations that we want, we need another filter on <code>tmax_missing</code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out</span> <span class="op">&lt;-</span> <span class="va">climate_small</span> <span class="op">%&gt;%</span>
  <span class="fu">zoom</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2020</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">global</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>tmax_missing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/all.html">all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">ts</span><span class="op">$</span><span class="va">tmax</span><span class="op">)</span><span class="op">)</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="va">tmax_missing</span><span class="op">)</span>

<span class="va">out</span></code></pre></div>
</div>
<div id="example-2" class="section level3">
<h3 class="hasAnchor">
<a href="#example-2" class="anchor"></a>Example 2</h3>
<p>Now we want to select the stations that have been registered with world meteorological organisation (WMO) and the dataset <code>station</code> has a column <code>wmo_id</code> that records this information. To do this task, we first need to join the <code>station</code> dataset with our climate dataset and then filter out those stations that don’t have the WMO id. Since the join is by station rather than by time, we start with the nested form and write the exact same syntax of join and filter as with tidyverse.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># join wmo_id for each station</span>
<span class="va">to_join</span> <span class="op">&lt;-</span> <span class="va">station</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">wmo_id</span><span class="op">)</span>
<span class="va">out</span> <span class="op">&lt;-</span> <span class="va">climate_small</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">to_join</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"station"</span> <span class="op">=</span> <span class="st">"id"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">wmo_id</span><span class="op">)</span><span class="op">)</span>
<span class="va">out</span></code></pre></div>
</div>
<div id="example-3" class="section level3">
<h3 class="hasAnchor">
<a href="#example-3" class="anchor"></a>Example 3</h3>
<p>Sometimes, we would like to have station-wise and time-wise variables in the same form (i.e. when plotting glyph maps). This can also be seen as a joining task, on the long form, with the dataset to join being the metadata. <code><a href="../reference/migrate.html">migrate()</a></code> is a verb introduced as the shortcut for <code><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join()</a></code> with a cubble’s metadata and below is the comparison of the two syntaxes.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">out</span> <span class="op">%&gt;%</span> 
  <span class="fu">zoom</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/migrate.html">migrate</a></span><span class="op">(</span><span class="va">lat</span>, <span class="va">long</span><span class="op">)</span>

<span class="va">out</span> <span class="op">%&gt;%</span> 
  <span class="fu">zoom</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="fu">meta</span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">station</span>, <span class="va">lat</span>, <span class="va">long</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="time-series-as-a-tsibble-object" class="section level2">
<h2 class="hasAnchor">
<a href="#time-series-as-a-tsibble-object" class="anchor"></a>Time series as a tsibble object</h2>
<p>Cubble also support a tsibble data structure for time series computation.</p>
<div id="creation" class="section level3">
<h3 class="hasAnchor">
<a href="#creation" class="anchor"></a>Creation</h3>
<p>A cubble can also be created from an underlying tsibble object. The resulting nested form shows a <code>tbl_ts</code> type for each nested cell in the <code>ts</code> column and a tsibble heading in the long form.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">climate_tsibble</span> <span class="op">&lt;-</span> <span class="va">climate_flat</span> <span class="op">%&gt;%</span> <span class="fu">tsibble</span><span class="fu">::</span><span class="fu"><a href="https://tsibble.tidyverts.org/reference/as-tsibble.html">as_tsibble</a></span><span class="op">(</span>index <span class="op">=</span> <span class="va">date</span>, key <span class="op">=</span> <span class="va">station</span><span class="op">)</span>
<span class="va">oz_global2</span> <span class="op">&lt;-</span> <span class="va">climate_tsibble</span> <span class="op">%&gt;%</span> <span class="fu">global</span><span class="op">(</span><span class="va">station</span><span class="op">)</span>
<span class="va">oz_zoom2</span> <span class="op">&lt;-</span> <span class="va">oz_global2</span> <span class="op">%&gt;%</span> <span class="fu">zoom</span><span class="op">(</span><span class="op">)</span>

<span class="va">oz_global2</span>
<span class="va">oz_zoom2</span></code></pre></div>
</div>
<div id="manipulation-1" class="section level3">
<h3 class="hasAnchor">
<a href="#manipulation-1" class="anchor"></a>Manipulation</h3>
<p>With a tsibble structure, we can make a monthly summary of our variables. Here is an example on calculating the monthly total precipitation and average max/min temperature in 2020. As before, we start with the long form to filter out the records that are not in 2020 and add a <code>ym</code> variable as the yearmonth representation of the date. <code>index_by</code> adds another grouping on the <code>ym</code> variable for computing the corresponding monthly summary.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">time_wise2</span> <span class="op">&lt;-</span> <span class="va">climate_small</span> <span class="op">%&gt;%</span> 
  <span class="fu">zoom</span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="http://lubridate.tidyverse.org/reference/year.html">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2020</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ym <span class="op">=</span> <span class="fu">tsibble</span><span class="fu">::</span><span class="fu"><a href="https://tsibble.tidyverts.org/reference/year-month.html">yearmonth</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tsibble.tidyverts.org/reference/index-by.html">index_by</a></span><span class="op">(</span><span class="va">ym</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>prcp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">prcp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="va">tmax</span><span class="op">:</span><span class="va">tmin</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="va">time_wise2</span></code></pre></div>
</div>
</div>
<div id="sampling-and-add-missing-summary" class="section level2">
<h2 class="hasAnchor">
<a href="#sampling-and-add-missing-summary" class="anchor"></a>Sampling and add missing summary</h2>
<p>[add documentation on slicing]</p>
<p>Missing summary gives a better view of the data quality recorded in each station.</p>
<ul>
<li>
<code><a href="../reference/add_missing_prct.html">add_missing_prct()</a></code> binds <code>{VAR}_missing</code> columns to calculate the percentage of missing for each station.</li>
<li>
<code><a href="../reference/add_missing_prct.html">add_missing_dscrb()</a></code> categories the percentage missing calculated into three categories: almost no missing, some missing, and almost all missing. The two cutoff values can be specified for switching between categories. This categorisation is to be further used for the viz [more on this].</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">climate_small</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/add_missing_prct.html">add_missing_prct</a></span><span class="op">(</span><span class="va">prcp</span><span class="op">:</span> <span class="va">tmax</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/add_missing_prct.html">add_missing_dscrb</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by H. Sherry Zhang, Dianne Cook, Ursula Laa, Nicolas Langrené, Patricia Menéndez.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
