<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>4. Application: Spatial and temporal aggregation • cubble</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="4. Application: Spatial and temporal aggregation">
<meta property="og:description" content="cubble">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cubble</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.1.0000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/0-create-cubble-from-wild.html">0. Creating a cubble from data in the wild</a>
    </li>
    <li>
      <a href="../articles/1-details-on-cubble-design.html">1. details-on-cubble-design</a>
    </li>
    <li>
      <a href="../articles/2-data-manip-with-cubble.html">2. Data manipulation with cubble</a>
    </li>
    <li>
      <a href="../articles/3-application-automated-stations.html">3. Application: Matching nearby stations</a>
    </li>
    <li>
      <a href="../articles/4-spatial-temporal-aggregation.html">4. Application: Spatial and temporal aggregation</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="4-spatial-temporal-aggregation_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>4. Application: Spatial and temporal aggregation</h1>
            
      
      
      <div class="hidden name"><code>4-spatial-temporal-aggregation.Rmd</code></div>

    </div>

    
    
<p>On top of <code>aus_climate</code> data in this package, <code>climate_full</code> from package <a href="https://github.com/huizezhang-sherry/weatherdata" class="external-link"><code>weatherdata</code></a> has daily climate data of 639 Australia stations from 2016 to 2020. This is where these stations locate in an Australia map:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">state_map</span> <span class="op">&lt;-</span> <span class="fu">rmapshaper</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rmapshaper/man/ms_simplify.html" class="external-link">ms_simplify</a></span><span class="op">(</span><span class="fu">ozmaps</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ozmaps/man/abs-data.html" class="external-link">abs_ste</a></span>, keep <span class="op">=</span> <span class="fl">2e-3</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">state_map</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu">weatherdata</span><span class="fu">::</span><span class="va">climate_full</span> , <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">long</span>, y <span class="op">=</span> <span class="va">lat</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="4-spatial-temporal-aggregation_files/figure-html/unnamed-chunk-2-1.png" width="100%"></p>
<p>This is a lot of stations to look at for one climate variable and they can’t all fit into a glyph map. What we can do is to group stations into clusters and look at the aggregated series in the glyph map. In this vignette, I will introduce how to perform spatial (and temporal) aggregation using hierarchical data structure in cubble.</p>
<p>First let’s add a new column <code>ll</code> for calculating distance matrix in the next section and aggregate the daily precipitation into weekly measure. These steps should be familiar from the vignette <em>Data manipulation with cubble</em>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">station_nested</span> <span class="op">&lt;-</span> <span class="fu">weatherdata</span><span class="fu">::</span><span class="va">climate_full</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ll <span class="op">=</span> <span class="fu">s2_lnglat</span><span class="op">(</span><span class="va">long</span>, <span class="va">lat</span><span class="op">)</span><span class="op">)</span>  <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/stretch.html">stretch</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>wk <span class="op">=</span> <span class="fu">lubridate</span><span class="fu">::</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/week.html" class="external-link">week</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">wk</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>prcp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">prcp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/tamp.html">tamp</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="section level2">
<h2 id="hierarchical-data-structure">Hierarchical data structure<a class="anchor" aria-label="anchor" href="#hierarchical-data-structure"></a>
</h2>
<p>Imposing a clustering structure can be thought of as building a hierarchical structure where stations are nested within clusters. As an example to illustrate here, we use a kmean clustering algorithm based on the distance matrix and specify the number of centers to be 20. More complex algorithms can also be used for more complex problem, as long as a mapping from each station id to the cluster id can be constructed. We then join this data to our station data:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dist_raw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/scale.html" class="external-link">scale</a></span><span class="op">(</span><span class="fu">s2_distance_matrix</span><span class="op">(</span><span class="va">station_nested</span><span class="op">$</span><span class="va">ll</span>, <span class="va">station_nested</span><span class="op">$</span><span class="va">ll</span><span class="op">)</span><span class="op">)</span>

<span class="va">cluster_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">station_nested</span><span class="op">$</span><span class="va">id</span>,
                      cluster <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="va">dist_raw</span>, centers <span class="op">=</span> <span class="fl">20</span>, nstart <span class="op">=</span> <span class="fl">50</span><span class="op">)</span><span class="op">$</span><span class="va">cluster</span><span class="op">)</span>

<span class="va">station_nested</span> <span class="op">&lt;-</span> <span class="va">station_nested</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">cluster_res</span><span class="op">)</span> 
<span class="va">station_nested</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># cubble:   id [5]: nested form</span></span>
<span class="co">#&gt; <span style="color: #949494;"># bbox:     [126.1, -16.42, 128.16, -13.75]</span></span>
<span class="co">#&gt; <span style="color: #949494;"># temporal: wk [dbl], prcp [dbl]</span></span>
<span class="co">#&gt;   id            lat  long  elev name             wmo_id ll      ts       cluster</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;s2_ln&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ASN00001006 -<span style="color: #BB0000;">15.5</span>  128.   3.8 wyndham aero      <span style="text-decoration: underline;">95</span>214 (128.1… &lt;tibble&gt;      16</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ASN00001007 -<span style="color: #BB0000;">13.8</span>  126.   6   troughton island  <span style="text-decoration: underline;">94</span>102 (126.1… &lt;tibble&gt;      16</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ASN00001018 -<span style="color: #BB0000;">16.4</span>  126. 546   mount elizabeth   <span style="text-decoration: underline;">94</span>211 (126.1… &lt;tibble&gt;      16</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ASN00001019 -<span style="color: #BB0000;">14.3</span>  127.  23   kalumburu         <span style="text-decoration: underline;">94</span>100 (126.6… &lt;tibble&gt;      16</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span> ASN00001020 -<span style="color: #BB0000;">14.1</span>  126.  51   truscott          <span style="text-decoration: underline;">95</span>101 (126.3… &lt;tibble&gt;      16</span></code></pre></div>
<p>One thing we hope to do with the cluster is to find the coordinates of the centroid. These are variables variant to the station but invariant to the cluster and it would be nice to have a function that structure each cluster as a row. <code><a href="../reference/switch_key.html">switch_key()</a></code> is the function that does this: it lets you to specify a new key, say <code>cluster</code> and nests all spatial variables variant to <code>cluster</code> into a column. Temporal observations from different stations while within the same cluster are bound in the nested column <code>ts</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cluster_nested</span> <span class="op">&lt;-</span> <span class="va">station_nested</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/switch_key.html">switch_key</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span>
<span class="va">cluster_nested</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># cubble:   cluster [5]: nested form</span></span>
<span class="co">#&gt; <span style="color: #949494;"># bbox:     [113.53, -28.31, 153.21, -14.96]- check gap on long</span></span>
<span class="co">#&gt; <span style="color: #949494;"># temporal: id [chr], wk [dbl], prcp [dbl]</span></span>
<span class="co">#&gt;   cluster .val              ts                  </span>
<span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>              </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span>       1 <span style="color: #949494;">&lt;tibble [20 × 7]&gt;</span> <span style="color: #949494;">&lt;tibble [1,060 × 3]&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span>       2 <span style="color: #949494;">&lt;tibble [15 × 7]&gt;</span> <span style="color: #949494;">&lt;tibble [795 × 3]&gt;</span>  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span>       3 <span style="color: #949494;">&lt;tibble [13 × 7]&gt;</span> <span style="color: #949494;">&lt;tibble [689 × 3]&gt;</span>  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span>       4 <span style="color: #949494;">&lt;tibble [13 × 7]&gt;</span> <span style="color: #949494;">&lt;tibble [689 × 3]&gt;</span>  </span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span>       5 <span style="color: #949494;">&lt;tibble [28 × 7]&gt;</span> <span style="color: #949494;">&lt;tibble [1,484 × 3]&gt;</span></span></code></pre></div>
<p>This structure makes it easy to compute cluster level variable, although there are a few steps to calculate the centroid coordinates: we need to find the convex hull that wraps around the cluster, make it a polygon, find the centroid of the polygon and finally, extract the x and y coordinate of each centroid:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cluster_nested</span> <span class="op">&lt;-</span> <span class="va">cluster_nested</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>chull <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grDevices/chull.html" class="external-link">chull</a></span><span class="op">(</span><span class="va">.val</span><span class="op">$</span><span class="va">long</span>, <span class="va">.val</span><span class="op">$</span><span class="va">lat</span><span class="op">)</span><span class="op">)</span>,
         ll_cluster <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html" class="external-link">st_as_sfc</a></span><span class="op">(</span>
           <span class="fu">s2_make_polygon</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">.val</span><span class="op">$</span><span class="va">long</span><span class="op">[</span><span class="va">chull</span><span class="op">]</span><span class="op">)</span>, 
                           <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">.val</span><span class="op">$</span><span class="va">lat</span><span class="op">[</span><span class="va">chull</span><span class="op">]</span><span class="op">)</span>, oriented <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>,
         centroid <span class="op">=</span> <span class="fu">s2_centroid</span><span class="op">(</span><span class="va">ll_cluster</span><span class="op">)</span>,
         cent_long <span class="op">=</span> <span class="fu">s2_x</span><span class="op">(</span><span class="va">centroid</span><span class="op">)</span>,
         cent_lat <span class="op">=</span> <span class="fu">s2_y</span><span class="op">(</span><span class="va">centroid</span><span class="op">)</span><span class="op">)</span> 
<span class="va">cluster_nested</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># cubble:   cluster [5]: nested form</span></span>
<span class="co">#&gt; <span style="color: #949494;"># bbox:     [113.53, -28.31, 153.21, -14.96]- check gap on long</span></span>
<span class="co">#&gt; <span style="color: #949494;"># temporal: id [chr], wk [dbl], prcp [dbl]</span></span>
<span class="co">#&gt;   cluster .val     ts       chull                  ll_cluster centroid cent_long</span>
<span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>              <span style="color: #949494; font-style: italic;">&lt;POLYGON [°]&gt;</span> <span style="color: #949494; font-style: italic;">&lt;s2_geo&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span>       1 &lt;tibble&gt; &lt;tibble&gt; &lt;int&gt;  ((119.7989 -23.4169, 119.… &lt;POINT …      116.</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span>       2 &lt;tibble&gt; &lt;tibble&gt; &lt;int&gt;  ((145.3106 -14.9672, 141.… &lt;POINT …      143.</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span>       3 &lt;tibble&gt; &lt;tibble&gt; &lt;int&gt;  ((146.0197 -18.2553, 146.… &lt;POINT …      147.</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span>       4 &lt;tibble&gt; &lt;tibble&gt; &lt;int&gt;  ((136.8192 -15.7426, 131.… &lt;POINT …      133.</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span>       5 &lt;tibble&gt; &lt;tibble&gt; &lt;int&gt;  ((152.7161 -24.1116, 150.… &lt;POINT …      151.</span>
<span class="co">#&gt; <span style="color: #949494;"># … with 1 more variable: cent_lat &lt;dbl&gt;</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="now-its-time-to-look-at-the-australia-precipitation">Now it’s time to look at the Australia precipitation<a class="anchor" aria-label="anchor" href="#now-its-time-to-look-at-the-australia-precipitation"></a>
</h2>
<p>After we have got <code>cluster_nested</code>, spatial and temporal data at both levels can be easily obtained. If we use <code>station</code> and <code>cluster</code> prefix to denote the two levels and <code>nested</code> and <code>long</code> for whether the data shows the spatial or temporal dimension, the relationship among the four datasets can be illustrated in the following workflow:</p>
<p><img src="../../reference/figures/hier-workflow.png" width="100%"></p>
<p>Start with the original <code>station_nested</code>, <code><a href="../reference/stretch.html">stretch()</a></code> expands the <code>ts</code> column with each station (<code>id</code>) forming a group and attach variables invariant to <code>id</code> as an attribute. <code><a href="../reference/switch_key.html">switch_key()</a></code> changes the <code>key</code> from <code>id</code> to <code>cluster</code> and nests all the spatial variables that variant to <code>cluster</code>. <code><a href="../reference/stretch.html">stretch()</a></code> <code>cluster_nested</code> will store variables that are invariant to <code>cluster</code> as a tibble in the attribute.</p>
<div class="section level3">
<h3 id="aggregated-overview">Aggregated overview<a class="anchor" aria-label="anchor" href="#aggregated-overview"></a>
</h3>
<p>Now we can obtain the aggregated series as described in the workflow diagram above and construct the glyph map with <code><a href="https://ggobi.github.io/ggally/reference/glyphs.html" class="external-link">GGally::glyphs()</a></code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cluster_long</span> <span class="op">&lt;-</span> <span class="va">cluster_nested</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/stretch.html">stretch</a></span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">wk</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>prcp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">prcp</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/cubble-verb.html">migrate</a></span><span class="op">(</span><span class="va">cent_long</span>, <span class="va">cent_lat</span><span class="op">)</span>

<span class="va">cluster_long</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># cubble:  date, cluster [1]: long form</span></span>
<span class="co">#&gt; <span style="color: #949494;"># bbox:    [113.53, -43.66, 153.64, -10.05]</span></span>
<span class="co">#&gt; <span style="color: #949494;"># spatial: id [chr], lat [dbl], long [dbl], elev [dbl], name [chr], wmo_id</span></span>
<span class="co"><span style="color: #949494;">#&gt; #   [dbl], ll [s2_lnglat], chull [list], ll_cluster [POLYGON [°]], centroid</span></span>
<span class="co"><span style="color: #949494;">#&gt; #   [s2_geography], cent_long [dbl], cent_lat [dbl]</span></span>
<span class="co">#&gt;   cluster    wk  prcp cent_long cent_lat</span>
<span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span>       1     1  <span style="text-decoration: underline;">1</span>345      116.    -<span style="color: #BB0000;">23.6</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span>       1     2 <span style="text-decoration: underline;">12</span>626      116.    -<span style="color: #BB0000;">23.6</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span>       1     3 <span style="text-decoration: underline;">11</span>341      116.    -<span style="color: #BB0000;">23.6</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span>       1     4  <span style="text-decoration: underline;">7</span>905      116.    -<span style="color: #BB0000;">23.6</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span>       1     5  <span style="text-decoration: underline;">9</span>622      116.    -<span style="color: #BB0000;">23.6</span></span>

<span class="fu"><a href="../reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">state_map</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">cluster_nested</span>, 
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cent_long</span>, y <span class="op">=</span> <span class="va">cent_lat</span>, label <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="../reference/glyph.html">geom_glyph</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">cluster_long</span>, 
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x_major <span class="op">=</span> <span class="va">cent_long</span>, x_minor <span class="op">=</span> <span class="va">wk</span>,
                y_major <span class="op">=</span> <span class="va">cent_lat</span>, y_minor <span class="op">=</span> <span class="va">prcp</span><span class="op">)</span>, 
            height <span class="op">=</span> <span class="fl">2</span>, width <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></code></pre></div>
<p><img src="4-spatial-temporal-aggregation_files/figure-html/unnamed-chunk-8-1.png" width="100%"></p>
</div>
<div class="section level3">
<h3 id="individual-series-within-the-cluster">Individual series within the cluster<a class="anchor" aria-label="anchor" href="#individual-series-within-the-cluster"></a>
</h3>
<p>We can also look at the precipitation of each individual station within the same cluster:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">station_long</span> <span class="op">&lt;-</span> <span class="va">station_nested</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/stretch.html">stretch</a></span><span class="op">(</span><span class="va">ts</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/cubble-verb.html">migrate</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span>

<span class="va">station_long</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt; <span style="color: #949494;"># cubble:  date, id [1]: long form</span></span>
<span class="co">#&gt; <span style="color: #949494;"># bbox:    [113.53, -43.66, 153.64, -10.05]</span></span>
<span class="co">#&gt; <span style="color: #949494;"># spatial: lat [dbl], long [dbl], elev [dbl], name [chr], wmo_id [dbl], ll</span></span>
<span class="co"><span style="color: #949494;">#&gt; #   [s2_lnglat], cluster [int]</span></span>
<span class="co">#&gt;   id             wk  prcp cluster</span>
<span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span>
<span class="co">#&gt; <span style="color: #BCBCBC;">1</span> ASN00001006     1  <span style="text-decoration: underline;">3</span>660      16</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">2</span> ASN00001006     2  <span style="text-decoration: underline;">1</span>766      16</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">3</span> ASN00001006     3  <span style="text-decoration: underline;">1</span>748      16</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">4</span> ASN00001006     4  <span style="text-decoration: underline;">4</span>614      16</span>
<span class="co">#&gt; <span style="color: #BCBCBC;">5</span> ASN00001006     5  <span style="text-decoration: underline;">1</span>080      16</span>

<span class="va">station_long</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">wk</span>, y <span class="op">=</span> <span class="va">prcp</span>, group <span class="op">=</span> <span class="va">id</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">cluster</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="4-spatial-temporal-aggregation_files/figure-html/unnamed-chunk-9-1.png" width="100%"></p>
</div>
<div class="section level3">
<h3 id="spot-the-weirdo">Spot the weirdo<a class="anchor" aria-label="anchor" href="#spot-the-weirdo"></a>
</h3>
<p>Lastly, there is one series on Tasmania island standing out from others, lets look at where it is:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># this part still needs some fixing</span>
<span class="va">tas_latlong</span> <span class="op">&lt;-</span> <span class="va">station_nested</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">lat</span> <span class="op">&lt;</span> <span class="op">-</span><span class="fl">40</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span>  
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ts</span><span class="op">$</span><span class="va">prcp</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="../reference/strip_rowwise.html">strip_rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">p</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span>

<span class="va">state_map</span> <span class="op">&lt;-</span> <span class="fu">rmapshaper</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rmapshaper/man/ms_simplify.html" class="external-link">ms_simplify</a></span><span class="op">(</span><span class="fu">ozmaps</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/ozmaps/man/abs-data.html" class="external-link">abs_ste</a></span>, keep <span class="op">=</span> <span class="fl">2e-3</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot_map.html">plot_map</a></span><span class="op">(</span><span class="va">state_map</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">station_nested</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">long</span>, y <span class="op">=</span> <span class="va">lat</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">cluster_nested</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>geometry <span class="op">=</span> <span class="va">ll_cluster</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">"transparent"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">tas_latlong</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">long</span>, y <span class="op">=</span> <span class="va">lat</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></code></pre></div>
<p><img src="4-spatial-temporal-aggregation_files/figure-html/unnamed-chunk-10-1.png" width="100%"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by H. Sherry Zhang, Dianne Cook, Ursula Laa, Nicolas Langrené, Patricia Menéndez.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
